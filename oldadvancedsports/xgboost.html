<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 XGBoost | Advanced Sports Data Analysis</title>
  <meta name="description" content="This is the companion text to the University of Nebraska-Lincoln’s SPMC 460: Advanced Sports Data Analysis" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 XGBoost | Advanced Sports Data Analysis" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is the companion text to the University of Nebraska-Lincoln’s SPMC 460: Advanced Sports Data Analysis" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 XGBoost | Advanced Sports Data Analysis" />
  
  <meta name="twitter:description" content="This is the companion text to the University of Nebraska-Lincoln’s SPMC 460: Advanced Sports Data Analysis" />
  

<meta name="author" content="By Matt Waite" />


<meta name="date" content="2022-02-27" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="decision-trees-and-random-forests.html"/>
<link rel="next" href="logistic-regression.html"/>
<script src="libs/header-attrs-2.11/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Advanced Sports Data Analysis</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#requirements-and-conventions"><i class="fa fa-check"></i><b>1.1</b> Requirements and Conventions</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#about-this-book"><i class="fa fa-check"></i><b>1.2</b> About this book</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="the-modeling-process-and-linear-regression.html"><a href="the-modeling-process-and-linear-regression.html"><i class="fa fa-check"></i><b>2</b> The modeling process and linear regression</a>
<ul>
<li class="chapter" data-level="2.1" data-path="the-modeling-process-and-linear-regression.html"><a href="the-modeling-process-and-linear-regression.html#feature-engineering"><i class="fa fa-check"></i><b>2.1</b> Feature engineering</a></li>
<li class="chapter" data-level="2.2" data-path="the-modeling-process-and-linear-regression.html"><a href="the-modeling-process-and-linear-regression.html#setting-up-the-modeling-process"><i class="fa fa-check"></i><b>2.2</b> Setting up the modeling process</a></li>
<li class="chapter" data-level="2.3" data-path="the-modeling-process-and-linear-regression.html"><a href="the-modeling-process-and-linear-regression.html#predicting-based-on-the-model"><i class="fa fa-check"></i><b>2.3</b> Predicting based on the model</a></li>
<li class="chapter" data-level="2.4" data-path="the-modeling-process-and-linear-regression.html"><a href="the-modeling-process-and-linear-regression.html#predicting-data-we-havent-seen-before"><i class="fa fa-check"></i><b>2.4</b> Predicting data we haven’t seen before</a></li>
<li class="chapter" data-level="2.5" data-path="the-modeling-process-and-linear-regression.html"><a href="the-modeling-process-and-linear-regression.html#looking-locally"><i class="fa fa-check"></i><b>2.5</b> Looking locally</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="multiple-regression.html"><a href="multiple-regression.html"><i class="fa fa-check"></i><b>3</b> Multiple regression</a>
<ul>
<li class="chapter" data-level="3.1" data-path="multiple-regression.html"><a href="multiple-regression.html#a-multiple-regression-speed-run"><i class="fa fa-check"></i><b>3.1</b> A multiple regression speed run</a></li>
<li class="chapter" data-level="3.2" data-path="multiple-regression.html"><a href="multiple-regression.html#picking-what-moves-the-needle"><i class="fa fa-check"></i><b>3.2</b> Picking what moves the needle</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="decision-trees-and-random-forests.html"><a href="decision-trees-and-random-forests.html"><i class="fa fa-check"></i><b>4</b> Decision trees and random forests</a>
<ul>
<li class="chapter" data-level="4.1" data-path="decision-trees-and-random-forests.html"><a href="decision-trees-and-random-forests.html#an-intro-to-pre-processing"><i class="fa fa-check"></i><b>4.1</b> An intro to pre-processing</a></li>
<li class="chapter" data-level="4.2" data-path="decision-trees-and-random-forests.html"><a href="decision-trees-and-random-forests.html#decision-trees"><i class="fa fa-check"></i><b>4.2</b> Decision trees</a></li>
<li class="chapter" data-level="4.3" data-path="decision-trees-and-random-forests.html"><a href="decision-trees-and-random-forests.html#random-forest"><i class="fa fa-check"></i><b>4.3</b> Random forest</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="xgboost.html"><a href="xgboost.html"><i class="fa fa-check"></i><b>5</b> XGBoost</a>
<ul>
<li class="chapter" data-level="5.1" data-path="xgboost.html"><a href="xgboost.html#hyperparameters"><i class="fa fa-check"></i><b>5.1</b> Hyperparameters</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="logistic-regression.html"><a href="logistic-regression.html"><i class="fa fa-check"></i><b>6</b> Logistic Regression</a>
<ul>
<li class="chapter" data-level="6.1" data-path="logistic-regression.html"><a href="logistic-regression.html#visualizing-the-decision-boundary"><i class="fa fa-check"></i><b>6.1</b> Visualizing the decision boundary</a></li>
<li class="chapter" data-level="6.2" data-path="logistic-regression.html"><a href="logistic-regression.html#the-logistic-regression"><i class="fa fa-check"></i><b>6.2</b> The logistic regression</a></li>
<li class="chapter" data-level="6.3" data-path="logistic-regression.html"><a href="logistic-regression.html#evaluating-the-fit"><i class="fa fa-check"></i><b>6.3</b> Evaluating the fit</a></li>
<li class="chapter" data-level="6.4" data-path="logistic-regression.html"><a href="logistic-regression.html#comparing-it-to-test-data"><i class="fa fa-check"></i><b>6.4</b> Comparing it to test data</a></li>
<li class="chapter" data-level="6.5" data-path="logistic-regression.html"><a href="logistic-regression.html#how-well-did-it-do-with-nebraska"><i class="fa fa-check"></i><b>6.5</b> How well did it do with Nebraska?</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="using-random-forests-to-predict-winners.html"><a href="using-random-forests-to-predict-winners.html"><i class="fa fa-check"></i><b>7</b> Using random forests to predict winners</a>
<ul>
<li class="chapter" data-level="7.1" data-path="using-random-forests-to-predict-winners.html"><a href="using-random-forests-to-predict-winners.html#setup"><i class="fa fa-check"></i><b>7.1</b> Setup</a></li>
<li class="chapter" data-level="7.2" data-path="using-random-forests-to-predict-winners.html"><a href="using-random-forests-to-predict-winners.html#predicting-a-future-game"><i class="fa fa-check"></i><b>7.2</b> Predicting a future game</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="xgboost-to-make-classifications.html"><a href="xgboost-to-make-classifications.html"><i class="fa fa-check"></i><b>8</b> XGBoost to make classifications</a></li>
<li class="chapter" data-level="9" data-path="support-vector-machines.html"><a href="support-vector-machines.html"><i class="fa fa-check"></i><b>9</b> Support Vector Machines</a>
<ul>
<li class="chapter" data-level="9.1" data-path="support-vector-machines.html"><a href="support-vector-machines.html#logistic-regression-1"><i class="fa fa-check"></i><b>9.1</b> Logistic regression</a></li>
<li class="chapter" data-level="9.2" data-path="support-vector-machines.html"><a href="support-vector-machines.html#random-forest-1"><i class="fa fa-check"></i><b>9.2</b> Random forest</a></li>
<li class="chapter" data-level="9.3" data-path="support-vector-machines.html"><a href="support-vector-machines.html#support-vector-machine"><i class="fa fa-check"></i><b>9.3</b> Support Vector Machine</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Advanced Sports Data Analysis</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="xgboost" class="section level1" number="5">
<h1><span class="header-section-number">Chapter 5</span> XGBoost</h1>
<p>As we learned in the previous chapter, random forests (and bagged methods) average together a large number of trees to get to an answer. Random forests add a wrinkle by randomly choosing features at each branch to make it so each tree is not correlated and the trees are rather deep. The idea behind averaging them together is to cut down on the variance in predictions – random forests tend to be somewhat harder to fit to unseen data because of the variance. Random forests are fairly simple to implement, and are very popular.</p>
<p>Boosting methods are another wrinkle in the tree based methods. Instead of deep trees, boosting methods intentionally pick shallow trees – called stumps – that, at least initially, do a poor job of predicting the outcome. Then, each subsequent stump takes the job the previous one did, optimizes to reduce the residuals – the gap between prediction and reality – and makes a prediction. And then the next one does the same, and so on and so on.</p>
<p>The path to a boosted method is complex, the results can take a lot of your computer’s time, but the models are more generalizable, meaning they handle new data better than other methods. Among data scientists, boosted methods, such as xgboost, are very popular for solving a wide variety of problems.</p>
<p>Let’s re-implement our predictions in an XGBoost algorithm. First, we’ll load libraries and we’re going to introduce a new one here – doParallel – which handles using more of your computer’s processor cores to accomplish tasks in parallel instead of one core at a time. In other words, instead of one task, it can do X at a time in parallel and put the answers together after.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="xgboost.html#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb84-2"><a href="xgboost.html#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb84-3"><a href="xgboost.html#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(zoo)</span>
<span id="cb84-4"><a href="xgboost.html#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hoopR)</span>
<span id="cb84-5"><a href="xgboost.html#cb84-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-6"><a href="xgboost.html#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb84-7"><a href="xgboost.html#cb84-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-8"><a href="xgboost.html#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span>
<span id="cb84-9"><a href="xgboost.html#cb84-9" aria-hidden="true" tabindex="-1"></a>cores <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>(<span class="at">logical =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>We’ll load our game data and do a spot of feature engineering that we used with random forests.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="xgboost.html#cb85-1" aria-hidden="true" tabindex="-1"></a>teamgames <span class="ot">&lt;-</span> <span class="fu">load_mbb_team_box</span>(<span class="at">seasons =</span> <span class="dv">2015</span><span class="sc">:</span><span class="dv">2022</span>) <span class="sc">%&gt;%</span></span>
<span id="cb85-2"><a href="xgboost.html#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(field_goals_made_field_goals_attempted, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;field_goals_made&quot;</span>,<span class="st">&quot;field_goals_attempted&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb85-3"><a href="xgboost.html#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(three_point_field_goals_made_three_point_field_goals_attempted, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;three_point_field_goals_made&quot;</span>,<span class="st">&quot;three_point_field_goals_attempted&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb85-4"><a href="xgboost.html#cb85-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(free_throws_made_free_throws_attempted, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;free_throws_made&quot;</span>,<span class="st">&quot;free_throws_attempted&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb85-5"><a href="xgboost.html#cb85-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_at</span>(<span class="dv">12</span><span class="sc">:</span><span class="dv">34</span>, as.numeric)</span>
<span id="cb85-6"><a href="xgboost.html#cb85-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-7"><a href="xgboost.html#cb85-7" aria-hidden="true" tabindex="-1"></a>teamstats <span class="ot">&lt;-</span> teamgames <span class="sc">%&gt;%</span> </span>
<span id="cb85-8"><a href="xgboost.html#cb85-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(team_short_display_name, season) <span class="sc">%&gt;%</span></span>
<span id="cb85-9"><a href="xgboost.html#cb85-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(game_date) <span class="sc">%&gt;%</span></span>
<span id="cb85-10"><a href="xgboost.html#cb85-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb85-11"><a href="xgboost.html#cb85-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">team_score =</span> ((field_goals_made<span class="sc">-</span>three_point_field_goals_made) <span class="sc">*</span> <span class="dv">2</span>) <span class="sc">+</span> (three_point_field_goals_made<span class="sc">*</span><span class="dv">3</span>) <span class="sc">+</span> free_throws_made,</span>
<span id="cb85-12"><a href="xgboost.html#cb85-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">possessions =</span> field_goals_attempted <span class="sc">-</span> offensive_rebounds <span class="sc">+</span> turnovers <span class="sc">+</span> (.<span class="dv">475</span> <span class="sc">*</span> free_throws_attempted),</span>
<span id="cb85-13"><a href="xgboost.html#cb85-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">ppp =</span> team_score<span class="sc">/</span>possessions,</span>
<span id="cb85-14"><a href="xgboost.html#cb85-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_shooting_percentage =</span> (team_score <span class="sc">/</span> (<span class="dv">2</span><span class="sc">*</span>(field_goals_attempted <span class="sc">+</span> (.<span class="dv">44</span> <span class="sc">*</span> free_throws_attempted)))) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb85-15"><a href="xgboost.html#cb85-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">turnover_pct =</span> turnovers<span class="sc">/</span>(field_goals_attempted <span class="sc">+</span> <span class="fl">0.44</span> <span class="sc">*</span> free_throws_attempted <span class="sc">+</span> turnovers),</span>
<span id="cb85-16"><a href="xgboost.html#cb85-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">free_throw_factor =</span> free_throws_made<span class="sc">/</span>field_goals_attempted,</span>
<span id="cb85-17"><a href="xgboost.html#cb85-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">rolling_shooting_percentage =</span> <span class="fu">rollmean</span>(<span class="fu">lag</span>(field_goal_pct, <span class="at">n=</span><span class="dv">1</span>), <span class="at">k=</span><span class="dv">2</span>, <span class="at">align=</span><span class="st">&quot;right&quot;</span>, <span class="at">fill=</span><span class="cn">NA</span>),</span>
<span id="cb85-18"><a href="xgboost.html#cb85-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">rolling_ppp =</span> <span class="fu">rollmean</span>(<span class="fu">lag</span>(ppp, <span class="at">n=</span><span class="dv">1</span>), <span class="at">k=</span><span class="dv">2</span>, <span class="at">align=</span><span class="st">&quot;right&quot;</span>, <span class="at">fill=</span><span class="cn">NA</span>),</span>
<span id="cb85-19"><a href="xgboost.html#cb85-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">rolling_true_shooting_percentage =</span> <span class="fu">rollmean</span>(<span class="fu">lag</span>(true_shooting_percentage, <span class="at">n=</span><span class="dv">1</span>), <span class="at">k=</span><span class="dv">2</span>, <span class="at">align=</span><span class="st">&quot;right&quot;</span>, <span class="at">fill=</span><span class="cn">NA</span>),</span>
<span id="cb85-20"><a href="xgboost.html#cb85-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">rolling_turnover_percentage =</span> <span class="fu">rollmean</span>(<span class="fu">lag</span>(turnover_pct, <span class="at">n=</span><span class="dv">1</span>), <span class="at">k=</span><span class="dv">2</span>, <span class="at">align=</span><span class="st">&quot;right&quot;</span>, <span class="at">fill=</span><span class="cn">NA</span>),</span>
<span id="cb85-21"><a href="xgboost.html#cb85-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">rolling_free_throw_factor =</span> <span class="fu">rollmean</span>(<span class="fu">lag</span>(free_throw_factor, <span class="at">n=</span><span class="dv">1</span>), <span class="at">k=</span><span class="dv">2</span>, <span class="at">align=</span><span class="st">&quot;right&quot;</span>, <span class="at">fill=</span><span class="cn">NA</span>),    </span>
<span id="cb85-22"><a href="xgboost.html#cb85-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>()</span>
<span id="cb85-23"><a href="xgboost.html#cb85-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-24"><a href="xgboost.html#cb85-24" aria-hidden="true" tabindex="-1"></a>opponent <span class="ot">&lt;-</span> teamstats <span class="sc">%&gt;%</span> <span class="fu">select</span>(game_id, team_id, offensive_rebounds, defensive_rebounds) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">opponent_id=</span>team_id, <span class="at">opponent_offensive_rebounds =</span> offensive_rebounds, <span class="at">opponent_defensive_rebounds=</span>defensive_rebounds) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">opponent_id =</span> <span class="fu">as.numeric</span>(opponent_id))</span>
<span id="cb85-25"><a href="xgboost.html#cb85-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-26"><a href="xgboost.html#cb85-26" aria-hidden="true" tabindex="-1"></a>newteamstats <span class="ot">&lt;-</span> teamstats <span class="sc">%&gt;%</span> </span>
<span id="cb85-27"><a href="xgboost.html#cb85-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(opponent) <span class="sc">%&gt;%</span> </span>
<span id="cb85-28"><a href="xgboost.html#cb85-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb85-29"><a href="xgboost.html#cb85-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">orb =</span> offensive_rebounds <span class="sc">/</span> (offensive_rebounds <span class="sc">+</span> opponent_defensive_rebounds),</span>
<span id="cb85-30"><a href="xgboost.html#cb85-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">drb =</span> defensive_rebounds <span class="sc">/</span> (opponent_offensive_rebounds <span class="sc">+</span> defensive_rebounds),</span>
<span id="cb85-31"><a href="xgboost.html#cb85-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">rolling_orb =</span> <span class="fu">rollmean</span>(<span class="fu">lag</span>(orb, <span class="at">n=</span><span class="dv">1</span>), <span class="at">k=</span><span class="dv">2</span>, <span class="at">align=</span><span class="st">&quot;right&quot;</span>, <span class="at">fill=</span><span class="cn">NA</span>),</span>
<span id="cb85-32"><a href="xgboost.html#cb85-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">rolling_drb =</span> <span class="fu">rollmean</span>(<span class="fu">lag</span>(drb, <span class="at">n=</span><span class="dv">1</span>), <span class="at">k=</span><span class="dv">2</span>, <span class="at">align=</span><span class="st">&quot;right&quot;</span>, <span class="at">fill=</span><span class="cn">NA</span>)</span>
<span id="cb85-33"><a href="xgboost.html#cb85-33" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
<pre><code>## Joining, by = c(&quot;opponent_id&quot;, &quot;game_id&quot;)</code></pre>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="xgboost.html#cb87-1" aria-hidden="true" tabindex="-1"></a>modelgames <span class="ot">&lt;-</span> newteamstats <span class="sc">%&gt;%</span></span>
<span id="cb87-2"><a href="xgboost.html#cb87-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(team_short_display_name, opponent_name, game_date, season, team_score, rolling_true_shooting_percentage, rolling_free_throw_factor, rolling_turnover_percentage, rolling_orb, rolling_drb) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>()</span></code></pre></div>
<p>Per usual, we split our data into training and testing.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="xgboost.html#cb88-1" aria-hidden="true" tabindex="-1"></a>game_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(modelgames, <span class="at">prop =</span> .<span class="dv">8</span>)</span>
<span id="cb88-2"><a href="xgboost.html#cb88-2" aria-hidden="true" tabindex="-1"></a>game_train <span class="ot">&lt;-</span> <span class="fu">training</span>(game_split)</span>
<span id="cb88-3"><a href="xgboost.html#cb88-3" aria-hidden="true" tabindex="-1"></a>game_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(game_split)</span></code></pre></div>
<p>And our recipe.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="xgboost.html#cb89-1" aria-hidden="true" tabindex="-1"></a>game_rec <span class="ot">&lt;-</span> </span>
<span id="cb89-2"><a href="xgboost.html#cb89-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(team_score <span class="sc">~</span> ., <span class="at">data =</span> game_train) <span class="sc">%&gt;%</span></span>
<span id="cb89-3"><a href="xgboost.html#cb89-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(team_short_display_name, opponent_name, game_date, season, <span class="at">new_role =</span> <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb89-4"><a href="xgboost.html#cb89-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-5"><a href="xgboost.html#cb89-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(game_rec)</span></code></pre></div>
<pre><code>## # A tibble: 10 × 4
##    variable                         type    role      source  
##    &lt;chr&gt;                            &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;   
##  1 team_short_display_name          nominal ID        original
##  2 opponent_name                    nominal ID        original
##  3 game_date                        date    ID        original
##  4 season                           numeric ID        original
##  5 rolling_true_shooting_percentage numeric predictor original
##  6 rolling_free_throw_factor        numeric predictor original
##  7 rolling_turnover_percentage      numeric predictor original
##  8 rolling_orb                      numeric predictor original
##  9 rolling_drb                      numeric predictor original
## 10 team_score                       numeric outcome   original</code></pre>
<p>To this point, everything looks like what we’ve done before. Nothing has really changed. It’s about to.</p>
<div id="hyperparameters" class="section level2" number="5.1">
<h2><span class="header-section-number">5.1</span> Hyperparameters</h2>
<p>The hyperparameters are the inputs into the algorithm that make the fit. To find the ideal hyperparameters, you need to tune them. But first, let’s talk about the hyperparameters:</p>
<ol style="list-style-type: decimal">
<li>Number of trees – this is the total number of trees in the sequence. A gradient boosting algorithm will minimize residuals forever, so you need to tell it where to stop. That stopping point is different for every problem.</li>
<li>Learn rate – this controls how fast the algorithm goes down the gradient descent – how fast it learns. Too fast and you’ll overshoot the optimal stopping point and start going up the error curve. Too slow and you’ll never get to the optimal stopping point.</li>
<li>Tree depth – controls the depth of each individual tree. Too short and you’ll need a lot of them to get good results. Too deep and you risk overfitting.</li>
<li>Minimum number of observations in the terminal node – controls the complexity of each tree. Typical values range from 5-15, and higher values keep a model from figuring out relationships that are unique to that training set (ie overfitting).</li>
</ol>
<p>Other settings:</p>
<p>Loss reduction – this is the minimum loss reduction to make a new tree split. If the improvement hits this minimum, a split occurs. A low value and you get a complex tree. High value and you get a tree more robust to new data, but it’s more conservative.
Sample size – The fraction of the total training set that can be used for each boosting round. Low values may lead to underfitting, high to overfitting.
mtry – the number of predictors that will be randomly sampled at each split when making trees.</p>
<p>All of these combine to make the model, and each has their own specific ideal. How do we find it? Tuning.</p>
<p>First, we make a mode and label each parameter as tune()</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="xgboost.html#cb91-1" aria-hidden="true" tabindex="-1"></a>xg_mod <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(</span>
<span id="cb91-2"><a href="xgboost.html#cb91-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="fu">tune</span>(), </span>
<span id="cb91-3"><a href="xgboost.html#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_rate =</span> <span class="fu">tune</span>(),</span>
<span id="cb91-4"><a href="xgboost.html#cb91-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="fu">tune</span>(), </span>
<span id="cb91-5"><a href="xgboost.html#cb91-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_n =</span> <span class="fu">tune</span>(),</span>
<span id="cb91-6"><a href="xgboost.html#cb91-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss_reduction =</span> <span class="fu">tune</span>(), </span>
<span id="cb91-7"><a href="xgboost.html#cb91-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_size =</span> <span class="fu">tune</span>(), </span>
<span id="cb91-8"><a href="xgboost.html#cb91-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="fu">tune</span>(), </span>
<span id="cb91-9"><a href="xgboost.html#cb91-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb91-10"><a href="xgboost.html#cb91-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">&quot;regression&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb91-11"><a href="xgboost.html#cb91-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">&quot;xgboost&quot;</span>, <span class="at">nthread =</span> cores)</span></code></pre></div>
<p>Let’s make a workflow now that we have our recipe and our model.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="xgboost.html#cb92-1" aria-hidden="true" tabindex="-1"></a>game_wflow <span class="ot">&lt;-</span> </span>
<span id="cb92-2"><a href="xgboost.html#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb92-3"><a href="xgboost.html#cb92-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(xg_mod) <span class="sc">%&gt;%</span> </span>
<span id="cb92-4"><a href="xgboost.html#cb92-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(game_rec)</span></code></pre></div>
<p>Now, to tune the model, we have to create a grid. The grid is essentially a random sample of parameters to try. The latin hypercube is a method of creating a near-random sample of parameter values in multidimentional distributions (ie there’s more than one predictor). The latin hypercube is near-random because there has to be one sample in each row and column of the hypercube. Essentially, it removes the possibility of totally empty spaces in the cube. What follows is what parameters the hypercube will tune.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="xgboost.html#cb93-1" aria-hidden="true" tabindex="-1"></a>xgb_grid <span class="ot">&lt;-</span> <span class="fu">grid_latin_hypercube</span>(</span>
<span id="cb93-2"><a href="xgboost.html#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">trees</span>(),</span>
<span id="cb93-3"><a href="xgboost.html#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tree_depth</span>(),</span>
<span id="cb93-4"><a href="xgboost.html#cb93-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">min_n</span>(),</span>
<span id="cb93-5"><a href="xgboost.html#cb93-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loss_reduction</span>(),</span>
<span id="cb93-6"><a href="xgboost.html#cb93-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_size =</span> <span class="fu">sample_prop</span>(),</span>
<span id="cb93-7"><a href="xgboost.html#cb93-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize</span>(<span class="fu">mtry</span>(), game_train),</span>
<span id="cb93-8"><a href="xgboost.html#cb93-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">learn_rate</span>(),</span>
<span id="cb93-9"><a href="xgboost.html#cb93-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">size =</span> <span class="dv">30</span></span>
<span id="cb93-10"><a href="xgboost.html#cb93-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb93-11"><a href="xgboost.html#cb93-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-12"><a href="xgboost.html#cb93-12" aria-hidden="true" tabindex="-1"></a>xgb_grid</span></code></pre></div>
<pre><code>## # A tibble: 30 × 7
##    trees tree_depth min_n loss_reduction sample_size  mtry    learn_rate
##    &lt;int&gt;      &lt;int&gt; &lt;int&gt;          &lt;dbl&gt;       &lt;dbl&gt; &lt;int&gt;         &lt;dbl&gt;
##  1  1749         13     5        1.18e-3       0.581     4 0.0000000175 
##  2   262         10    34        2.21e-7       0.626     2 0.000000158  
##  3  1837         11    37        7.42e-9       0.825     4 0.00204      
##  4   524         12    28        3.06e-9       0.282     7 0.00000390   
##  5   981         15    29        9.62e-3       0.331     8 0.00000000421
##  6  1674          3     9        2.90e+1       0.517     9 0.000000400  
##  7  1210          8    31        2.12e-5       0.408     6 0.000266     
##  8  1912         12    25        8.83e-9       0.930     3 0.00961      
##  9   403          4    10        2.41e-8       0.439     9 0.00145      
## 10   170          8    38        6.28e-7       0.658     6 0.000138     
## # … with 20 more rows</code></pre>
<p>How do we tune it? Using something called cross fold validation. Cross fold validation takes our grid, applies it to a set of subsets (in our case 10 subsets) and compares. When it’s done, each validation set will have a set of tuned values and outcomes that we can evaluate and pick the optimal set to get a result.</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="xgboost.html#cb95-1" aria-hidden="true" tabindex="-1"></a>game_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(game_train)</span>
<span id="cb95-2"><a href="xgboost.html#cb95-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-3"><a href="xgboost.html#cb95-3" aria-hidden="true" tabindex="-1"></a>game_folds</span></code></pre></div>
<pre><code>## #  10-fold cross-validation 
## # A tibble: 10 × 2
##    splits               id    
##    &lt;list&gt;               &lt;chr&gt; 
##  1 &lt;split [57960/6441]&gt; Fold01
##  2 &lt;split [57961/6440]&gt; Fold02
##  3 &lt;split [57961/6440]&gt; Fold03
##  4 &lt;split [57961/6440]&gt; Fold04
##  5 &lt;split [57961/6440]&gt; Fold05
##  6 &lt;split [57961/6440]&gt; Fold06
##  7 &lt;split [57961/6440]&gt; Fold07
##  8 &lt;split [57961/6440]&gt; Fold08
##  9 &lt;split [57961/6440]&gt; Fold09
## 10 &lt;split [57961/6440]&gt; Fold10</code></pre>
<p>This part takes about 25-30 minutes on my machine and it will saturate all of your processors, so your computer just needs to sit there. No texting, no YouTube, nothing. Let it burn.</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="xgboost.html#cb97-1" aria-hidden="true" tabindex="-1"></a>doParallel<span class="sc">::</span><span class="fu">registerDoParallel</span>(<span class="at">cores =</span> cores)</span>
<span id="cb97-2"><a href="xgboost.html#cb97-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-3"><a href="xgboost.html#cb97-3" aria-hidden="true" tabindex="-1"></a>xgb_res <span class="ot">&lt;-</span> <span class="fu">tune_grid</span>(</span>
<span id="cb97-4"><a href="xgboost.html#cb97-4" aria-hidden="true" tabindex="-1"></a>  game_wflow,</span>
<span id="cb97-5"><a href="xgboost.html#cb97-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamples =</span> game_folds,</span>
<span id="cb97-6"><a href="xgboost.html#cb97-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">grid =</span> xgb_grid,</span>
<span id="cb97-7"><a href="xgboost.html#cb97-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">control_grid</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>)</span>
<span id="cb97-8"><a href="xgboost.html#cb97-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-9"><a href="xgboost.html#cb97-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-10"><a href="xgboost.html#cb97-10" aria-hidden="true" tabindex="-1"></a>doParallel<span class="sc">::</span><span class="fu">stopImplicitCluster</span>()</span>
<span id="cb97-11"><a href="xgboost.html#cb97-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-12"><a href="xgboost.html#cb97-12" aria-hidden="true" tabindex="-1"></a>xgb_res</span></code></pre></div>
<pre><code>## Warning: This tuning result has notes. Example notes on model fitting include:
## internal: A correlation computation is required, but `estimate` is constant and has 0 standard deviation, resulting in a divide by 0 error. `NA` will be returned.
## internal: A correlation computation is required, but `estimate` is constant and has 0 standard deviation, resulting in a divide by 0 error. `NA` will be returned.
## internal: A correlation computation is required, but `estimate` is constant and has 0 standard deviation, resulting in a divide by 0 error. `NA` will be returned.</code></pre>
<pre><code>## # Tuning results
## # 10-fold cross-validation 
## # A tibble: 10 × 5
##    splits               id     .metrics           .notes           .predictions 
##    &lt;list&gt;               &lt;chr&gt;  &lt;list&gt;             &lt;list&gt;           &lt;list&gt;       
##  1 &lt;split [57960/6441]&gt; Fold01 &lt;tibble [60 × 11]&gt; &lt;tibble [1 × 1]&gt; &lt;tibble [193…
##  2 &lt;split [57961/6440]&gt; Fold02 &lt;tibble [60 × 11]&gt; &lt;tibble [1 × 1]&gt; &lt;tibble [193…
##  3 &lt;split [57961/6440]&gt; Fold03 &lt;tibble [60 × 11]&gt; &lt;tibble [1 × 1]&gt; &lt;tibble [193…
##  4 &lt;split [57961/6440]&gt; Fold04 &lt;tibble [60 × 11]&gt; &lt;tibble [1 × 1]&gt; &lt;tibble [193…
##  5 &lt;split [57961/6440]&gt; Fold05 &lt;tibble [60 × 11]&gt; &lt;tibble [1 × 1]&gt; &lt;tibble [193…
##  6 &lt;split [57961/6440]&gt; Fold06 &lt;tibble [60 × 11]&gt; &lt;tibble [1 × 1]&gt; &lt;tibble [193…
##  7 &lt;split [57961/6440]&gt; Fold07 &lt;tibble [60 × 11]&gt; &lt;tibble [1 × 1]&gt; &lt;tibble [193…
##  8 &lt;split [57961/6440]&gt; Fold08 &lt;tibble [60 × 11]&gt; &lt;tibble [1 × 1]&gt; &lt;tibble [193…
##  9 &lt;split [57961/6440]&gt; Fold09 &lt;tibble [60 × 11]&gt; &lt;tibble [1 × 1]&gt; &lt;tibble [193…
## 10 &lt;split [57961/6440]&gt; Fold10 &lt;tibble [60 × 11]&gt; &lt;tibble [1 × 1]&gt; &lt;tibble [193…</code></pre>
<p>So our grid has run on all of our validation samples, and what do we see?</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="xgboost.html#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">collect_metrics</span>(xgb_res)</span></code></pre></div>
<pre><code>## # A tibble: 60 × 13
##     mtry trees min_n tree_depth   learn_rate loss_reduction sample_size .metric
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;      &lt;int&gt;        &lt;dbl&gt;          &lt;dbl&gt;       &lt;dbl&gt; &lt;chr&gt;  
##  1     9   555    13          1 0.00000138         0.110          0.575 rmse   
##  2     9   555    13          1 0.00000138         0.110          0.575 rsq    
##  3     5   103    15          2 0.00517            0.899          0.538 rmse   
##  4     5   103    15          2 0.00517            0.899          0.538 rsq    
##  5     1   683    39          2 0.00000263         0.000358       0.852 rmse   
##  6     1   683    39          2 0.00000263         0.000358       0.852 rsq    
##  7     9  1674     9          3 0.000000400       29.0            0.517 rmse   
##  8     9  1674     9          3 0.000000400       29.0            0.517 rsq    
##  9     2  1947    23          3 0.0000000107       4.30           0.947 rmse   
## 10     2  1947    23          3 0.0000000107       4.30           0.947 rsq    
## # … with 50 more rows, and 5 more variables: .estimator &lt;chr&gt;, mean &lt;dbl&gt;,
## #   n &lt;int&gt;, std_err &lt;dbl&gt;, .config &lt;chr&gt;</code></pre>
<p>Well we see 60 combinations and the metrics from them. But that doesn’t mean much to us just eyeballing it. We want to see the best combination.</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="xgboost.html#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(xgb_res, <span class="st">&quot;rmse&quot;</span>)</span></code></pre></div>
<pre><code>## # A tibble: 5 × 13
##    mtry trees min_n tree_depth learn_rate loss_reduction sample_size .metric
##   &lt;int&gt; &lt;int&gt; &lt;int&gt;      &lt;int&gt;      &lt;dbl&gt;          &lt;dbl&gt;       &lt;dbl&gt; &lt;chr&gt;  
## 1     3   908     7          6    0.0246   0.0646              0.721 rmse   
## 2     3  1912    25         12    0.00961  0.00000000883       0.930 rmse   
## 3     4  1837    37         11    0.00204  0.00000000742       0.825 rmse   
## 4     2   665    12          9    0.0520   2.06                0.350 rmse   
## 5     9  1633    21         13    0.0454   0.00000134          0.756 rmse   
## # … with 5 more variables: .estimator &lt;chr&gt;, mean &lt;dbl&gt;, n &lt;int&gt;,
## #   std_err &lt;dbl&gt;, .config &lt;chr&gt;</code></pre>
<p>The best combination as of this data update comes up with an RMSE of 9.93. Second is 9.97.</p>
<p>Let’s capture our best set of hyperparameters.</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="xgboost.html#cb104-1" aria-hidden="true" tabindex="-1"></a>best_rmse <span class="ot">&lt;-</span> <span class="fu">select_best</span>(xgb_res, <span class="st">&quot;rmse&quot;</span>)</span></code></pre></div>
<p>And now put that into a final workflow. Pay attention to the main arguments in the output below.</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="xgboost.html#cb105-1" aria-hidden="true" tabindex="-1"></a>final_xgb <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(</span>
<span id="cb105-2"><a href="xgboost.html#cb105-2" aria-hidden="true" tabindex="-1"></a>  game_wflow,</span>
<span id="cb105-3"><a href="xgboost.html#cb105-3" aria-hidden="true" tabindex="-1"></a>  best_rmse</span>
<span id="cb105-4"><a href="xgboost.html#cb105-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb105-5"><a href="xgboost.html#cb105-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-6"><a href="xgboost.html#cb105-6" aria-hidden="true" tabindex="-1"></a>final_xgb</span></code></pre></div>
<pre><code>## ══ Workflow ════════════════════════════════════════════════════════════════════
## Preprocessor: Recipe
## Model: boost_tree()
## 
## ── Preprocessor ────────────────────────────────────────────────────────────────
## 0 Recipe Steps
## 
## ── Model ───────────────────────────────────────────────────────────────────────
## Boosted Tree Model Specification (regression)
## 
## Main Arguments:
##   mtry = 3
##   trees = 908
##   min_n = 7
##   tree_depth = 6
##   learn_rate = 0.0245913955268473
##   loss_reduction = 0.0646470652479078
##   sample_size = 0.72087624378968
## 
## Engine-Specific Arguments:
##   nthread = cores
## 
## Computational engine: xgboost</code></pre>
<p>There’s our best set of hyperparameters. We’ve tuned this model to give the best possible set of results in those settings. Now we apply it like we have been doing all along.</p>
<p>We create a fit.</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="xgboost.html#cb107-1" aria-hidden="true" tabindex="-1"></a>xg_fit <span class="ot">&lt;-</span> </span>
<span id="cb107-2"><a href="xgboost.html#cb107-2" aria-hidden="true" tabindex="-1"></a>  final_xgb <span class="sc">%&gt;%</span> </span>
<span id="cb107-3"><a href="xgboost.html#cb107-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> game_train)</span></code></pre></div>
<p>We can see something things about that fit, including all the iterations of our XGBoost model. Note: our tuned number of trees is 1,743 – and in the workflow fit, you can see 1,743 iterations. Remember: Boosted models work sequentially. One after the other. So you can see it at work. The RMSE goes down with each iteration as we go down the gradient desent.</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="xgboost.html#cb108-1" aria-hidden="true" tabindex="-1"></a>xg_fit <span class="sc">%&gt;%</span> </span>
<span id="cb108-2"><a href="xgboost.html#cb108-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull_workflow_fit</span>() </span></code></pre></div>
<pre><code>## Warning: `pull_workflow_fit()` was deprecated in workflows 0.2.3.
## Please use `extract_fit_parsnip()` instead.</code></pre>
<pre><code>## parsnip model object
## 
## Fit time:  31.4s 
## ##### xgb.Booster
## raw: 4.1 Mb 
## call:
##   xgboost::xgb.train(params = list(eta = 0.0245913955268473, max_depth = 6L, 
##     gamma = 0.0646470652479078, colsample_bytree = 1, colsample_bynode = 0.6, 
##     min_child_weight = 7L, subsample = 0.72087624378968, objective = &quot;reg:squarederror&quot;), 
##     data = x$data, nrounds = 908L, watchlist = x$watchlist, verbose = 0, 
##     nthread = 6L)
## params (as set within xgb.train):
##   eta = &quot;0.0245913955268473&quot;, max_depth = &quot;6&quot;, gamma = &quot;0.0646470652479078&quot;, colsample_bytree = &quot;1&quot;, colsample_bynode = &quot;0.6&quot;, min_child_weight = &quot;7&quot;, subsample = &quot;0.72087624378968&quot;, objective = &quot;reg:squarederror&quot;, nthread = &quot;6&quot;, validate_parameters = &quot;TRUE&quot;
## xgb.attributes:
##   niter
## callbacks:
##   cb.evaluation.log()
## # of features: 5 
## niter: 908
## nfeatures : 5 
## evaluation_log:
##     iter training_rmse
##        1      70.42922
##        2      68.75217
## ---                   
##      907      11.62990
##      908      11.62942</code></pre>
<p>Now, like before, we can bind our predictions using our xg_fit to the game_train data.</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="xgboost.html#cb111-1" aria-hidden="true" tabindex="-1"></a>trainresults <span class="ot">&lt;-</span> game_train <span class="sc">%&gt;%</span></span>
<span id="cb111-2"><a href="xgboost.html#cb111-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(xg_fit, game_train))</span></code></pre></div>
<p>And now see how we did.</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="xgboost.html#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">metrics</span>(trainresults, <span class="at">truth =</span> team_score, <span class="at">estimate =</span> .pred)</span></code></pre></div>
<pre><code>## # A tibble: 3 × 3
##   .metric .estimator .estimate
##   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
## 1 rmse    standard      11.6  
## 2 rsq     standard       0.202
## 3 mae     standard       9.18</code></pre>
<p>How about the test data?</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="xgboost.html#cb114-1" aria-hidden="true" tabindex="-1"></a>testresults <span class="ot">&lt;-</span> game_test <span class="sc">%&gt;%</span></span>
<span id="cb114-2"><a href="xgboost.html#cb114-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(xg_fit, game_test))</span></code></pre></div>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="xgboost.html#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">metrics</span>(testresults, <span class="at">truth =</span> team_score, <span class="at">estimate =</span> .pred)</span></code></pre></div>
<pre><code>## # A tibble: 3 × 3
##   .metric .estimator .estimate
##   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
## 1 rmse    standard     12.5   
## 2 rsq     standard      0.0766
## 3 mae     standard      9.85</code></pre>
<p>Unlike the random forest, not nearly the drop in metrics between train and test.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="decision-trees-and-random-forests.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="logistic-regression.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/04-xgboost.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["advancedsportsdataanalysis.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
