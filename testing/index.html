<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soil Lead Test Search</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a cleaner interface */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .result-card {
            transition: all 0.2s ease-in-out;
        }
        .result-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="text-center py-6 mb-8 bg-white rounded-xl shadow-lg">
            <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-700 tracking-tight">
                Find out if your soil has been tested for lead
            </h1>
            <p class="mt-2 text-lg text-gray-500">Search by address to check testing status and results.</p>
        </header>

        <!-- Search Input -->
        <div class="mb-8">
            <input
                type="text"
                id="searchInput"
                placeholder="Enter street address (e.g., 3101 S 2 ST)"
                class="w-full p-4 text-lg border-2 border-indigo-300 rounded-xl shadow-inner focus:outline-none focus:ring-4 focus:ring-indigo-200 transition duration-200"
                oninput="handleSearch(event.target.value)"
                autocomplete="off"
            >
        </div>

        <!-- Loading & Results Container -->
        <div id="loading" class="text-center text-indigo-500 font-semibold hidden">
            Loading data... Please wait.
        </div>
        <div id="resultsContainer" class="space-y-4">
            <!-- Results will be injected here -->
            <div id="initialMessage" class="bg-indigo-100 p-6 rounded-xl text-indigo-700 text-center text-lg font-medium shadow-md">
                Start typing an address above to see results.
            </div>
        </div>
    </div>

    <script>
        // NOTE: The application now expects a JSON file named 'lead_for_app.json'.
        const DATA_FILE_PATH = "lead_for_app.json";
        
        let allData = [];
        let searchTimeout;

        const resultsContainer = document.getElementById('resultsContainer');
        const loadingIndicator = document.getElementById('loading');
        const initialMessage = document.getElementById('initialMessage');

        // --- Data Loading (Updated for JSON) ---

        /**
         * Loads the JSON data file and normalizes addresses for searching.
         */
        async function loadData() {
            loadingIndicator.classList.remove('hidden');
            try {
                // STANDARD FETCH: Use standard fetch to load the data file from the same directory
                const response = await fetch(DATA_FILE_PATH);
                if (!response.ok) {
                    throw new Error(`Failed to load data file: ${response.statusText}`);
                }
                
                // Use the native JSON parser
                const rawData = await response.json();

                // Normalize data structure for searching
                allData = rawData
                    .filter(item => item.address && item.address.toUpperCase() !== 'NA')
                    .map(item => {
                        let result = item.result;
                        if (typeof result === 'string' && result.toUpperCase() === 'NA') {
                            result = 'NA';
                        } else if (typeof result === 'number') {
                            // Keep numbers as is
                        } else {
                            // Handle cases where the result might be a string that looks like a number
                            const num = parseFloat(result);
                            result = isNaN(num) ? 'NA' : num;
                        }

                        return {
                            id: item.id,
                            address: item.address.toUpperCase().trim(), // Normalize address for easier searching
                            result: result
                        };
                    });
                
                console.log(`Successfully loaded and parsed ${allData.length} data records from JSON.`);
                initialMessage.textContent = `Data loaded. Start typing to search ${allData.length} records.`;

            } catch (error) {
                console.error("Error loading or parsing JSON data:", error);
                resultsContainer.innerHTML = `
                    <div class="bg-red-100 p-6 rounded-xl text-red-700 text-center text-lg font-medium shadow-md">
                        Error loading data. Reason: **${error.message}**.
                        <br>
                        Please ensure **lead_for_app.json** exists in the same folder and is correctly formatted.
                    </div>
                `;
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // --- Search and Rendering ---

        /**
         * Handles filtering the data based on search input.
         * Implements a slight debounce for better performance while typing.
         * @param {string} query - The search string.
         */
        window.handleSearch = function(query) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const normalizedQuery = query.toUpperCase().trim();
                
                // Only show results if query is at least 2 characters long
                if (normalizedQuery.length < 2) {
                    renderResults([], normalizedQuery);
                    return;
                }

                const filtered = allData.filter(item => 
                    item.address.includes(normalizedQuery)
                );

                renderResults(filtered, normalizedQuery);
            }, 100); // Debounce delay
        };

        /**
         * Renders the search results to the DOM.
         * @param {Array<{id: string, address: string, result: (number|string)}>} results - The filtered data.
         * @param {string} query - The search query.
         */
        function renderResults(results, query) {
            resultsContainer.innerHTML = '';
            initialMessage.classList.add('hidden');

            if (query === '') {
                initialMessage.textContent = "Start typing an address above to see results.";
                initialMessage.classList.remove('hidden');
                return;
            }

            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="bg-yellow-100 p-6 rounded-xl text-yellow-700 text-center text-lg font-medium shadow-md">
                        No addresses found matching "${query}".
                        <br>Try a shorter or slightly different search term.
                    </div>
                `;
                return;
            }

            // Limit display to the first 50 results for performance
            const displayResults = results.slice(0, 50);

            if (results.length > 50) {
                 resultsContainer.innerHTML += `
                    <p class="text-sm text-gray-500 text-center mb-4">Displaying first 50 of ${results.length} results.</p>
                `;
            }

            displayResults.forEach(item => {
                let resultText = '';
                let bgColor = '';
                let statusText = '';
                let statusColor = '';

                // We are now checking item.result against 'NA' (string) or numbers
                if (item.result === 'NA') {
                    statusText = 'NOT TESTED';
                    statusColor = 'bg-gray-400';
                    resultText = 'This address has not been tested for soil lead in this dataset.';
                    bgColor = 'bg-gray-50';
                } else if (item.result > 400) { // Example threshold for high lead (EPA action level is 400 ppm for play areas)
                    statusText = 'HIGH LEAD RISK';
                    statusColor = 'bg-red-500';
                    resultText = `Result: ${item.result} ppm. This value is considered high.`;
                    bgColor = 'bg-red-50';
                } else if (item.result > 0) {
                    statusText = 'TESTED (Lead Present)';
                    statusColor = 'bg-orange-500';
                    resultText = `Result: ${item.result} ppm. Lead is present but below the high risk level of 400 ppm.`;
                    bgColor = 'bg-orange-50';
                } else { // result is 0
                    statusText = 'TESTED (No Lead Detected)';
                    statusColor = 'bg-green-500';
                    resultText = 'Result: 0 ppm. No significant lead detected.';
                    bgColor = 'bg-green-50';
                }

                resultsContainer.innerHTML += `
                    <div class="result-card ${bgColor} p-6 rounded-xl shadow-md border-l-4 border-indigo-500 flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <div class="flex-grow">
                            <p class="text-xl font-bold text-gray-800 mb-1">${item.address}</p>
                            <p class="text-gray-600 text-sm">${resultText}</p>
                        </div>
                        <div class="mt-3 sm:mt-0 sm:ml-4 flex-shrink-0">
                            <span class="inline-block px-3 py-1 text-xs font-semibold uppercase text-white rounded-full ${statusColor}">
                                ${statusText}
                            </span>
                        </div>
                    </div>
                `;
            });
        }

        // --- Initialization ---

        window.onload = loadData;

    </script>
</body>
</html>
